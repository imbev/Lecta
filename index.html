<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="preconnect" href="https://esm.sh" crossorigin />
        <meta name="color-scheme" content="light dark" />
        <link
            rel="modulepreload"
            href="https://esm.sh/nostr-tools@2.23.0/es2022/nostr-tools.bundle.mjs?exports=SimplePool"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.conditional.sand.min.css"
        />
        <style>
            body {
                padding-top: 0.5in;
                padding-bottom: 1in;
            }
            .container {
                max-width: 9in;
            }
            img,
            svg {
                max-width: 100%;
            }
            footer {
                display: flex;
                justify-content: space-between;
            }
            #form {
                display: flex;
                flex-direction: column;
                align-items: center;
                form {
                    display: grid;
                    grid-template-columns: auto auto;
                    gap: 0.25in;
                    max-width: 6in;
                    button {
                        grid-column-start: 2;
                        background-color: lightgrey;
                        color: black;
                        padding: 0.05in;
                        border-radius: 7.5px;
                        cursor: pointer;
                    }
                    textarea {
                        border-width: 2px;
                        border-radius: 7.5px;
                        min-height: 0.75in;
                        min-width: 2.5in;
                        padding: 0.125in;
                    }
                }
            }
            #author {
                display: flex;
                flex-direction: column;
            }
            #loading {
                padding-top: 2in;
                width: 100%;
                display: flex;
                justify-content: center;
                svg {
                    animation: loading 2s infinite;
                    height: 1in;
                    width: 1in;
                }
            }
            @keyframes loading {
                0% {
                    rotate: 0deg;
                }
                100% {
                    rotate: 360deg;
                }
            }
            @view-transition {
                navigation: auto;
            }
        </style>
    </head>
    <body>
        <main class="container">
            <div id="loading">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
                    />
                </svg>
            </div>
            <article id="post" style="display: none">
                <hgroup>
                    <h1 id="title"></h1>
                    <p id="summary"></p>
                </hgroup>
                <img id="image" />
                <br />

                <div id="author">
                    <b id="authorName"></b>
                    <span id="authorAbout"></span>
                </div>
                <hr />
                <section id="content"></section>
                <hr />
                <br />
                <footer>
                    <span
                        >Powered by <a href="https://nostr.com/">Nostr</a> +
                        <a href="https://github.com/imbev/Lecta">Lecta</a></span
                    >
                    <a id="share">Share this post with others</a>
                </footer>
            </article>
            <section id="form" style="display: none">
                <center><h3>Unable to load post</h3></center>
                <form method="get">
                    <label for="event">Choose Nostr event (hex):</label>
                    <textarea
                        id="event"
                        name="event"
                        placeholder="abcde..."
                        required
                    ></textarea>
                    <label for="relays">Choose Nostr relays (csv):</label>
                    <textarea
                        id="relays"
                        name="relays"
                        placeholder="wss://relay.nostr.band,&#13;&#10;wss://nos.lol/"
                        required
                    ></textarea>
                    <button type="submit">Query</button>
                </form>
            </section>
        </main>
        <script type="module">
            import { SimplePool } from "https://esm.sh/nostr-tools@2.23.0/es2022/nostr-tools.bundle.mjs?exports=SimplePool";
            import { marked } from "https://esm.sh/marked@17.0.1/es2022/marked.bundle.mjs?exports=marked";

            const pool = new SimplePool();
            const urlParams = new URLSearchParams(window.location.search);
            const relays = urlParams.get("relays")
                ? urlParams.get("relays").split(",")
                : undefined;
            const eventId = urlParams.get("event");

            var event = undefined;

            if (relays != undefined) {
                event = await pool.get(relays, {
                    ids: [eventId],
                });
                console.log(event);
            }

            if (event != undefined) {
                const post_author = await pool.get(relays, {
                    kinds: [0],
                    authors: [event.pubkey],
                    limit: 1,
                });
                if (post_author) {
                    const post_author_ = JSON.parse(post_author.content);
                    console.log(post_author_);
                    document.querySelector("#authorName").innerHTML =
                        "By: " +
                        (post_author_.display_name
                            ? post_author_.display_name
                            : post_author_.name);
                    document.querySelector("#authorAbout").innerHTML =
                        post_author_.about ? post_author_.about : "";
                }
                const post_title = event.tags.filter(
                    (tag) => tag[0] == "title",
                )[0][1];
                const post_summary = event.tags.filter(
                    (tag) => tag[0] == "summary",
                )[0][1];
                const post_image = event.tags.filter(
                    (tag) => tag[0] == "image",
                )[0][1];
                const post_content = marked.parse(event.content);

                document.title = post_title;
                document.querySelector("#title").innerHTML = post_title;
                document.querySelector("#summary").innerHTML = post_summary;
                document.querySelector("#image").src = post_image;
                document.querySelector("#content").innerHTML = post_content;

                document.querySelector("#share").href = window.location.href;

                document.querySelector("#loading").style.display = "none";
                document.querySelector("#post").style.display = "block";
            } else {
                console.log(event);
                document.querySelector("#event").value = urlParams.get("event");
                document.querySelector("#relays").value =
                    urlParams.get("relays");
                document.querySelector("#loading").style.display = "none";
                document.querySelector("#form").style.display = "flex";
            }
        </script>
    </body>
</html>
